name: CD - Deploy StuCents App

on:
  push:
    branches:
      - main

env:
  ACR_NAME: stucentsregistry
  IMAGE_NAME: stucents-app1
  IMAGE_TAG: v1
  RESOURCE_GROUP: stucents-rg
  CONTAINER_APP_NAME: stucentsapp1
  LOCATION: francecentral

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Init
      run: terraform init

    - name: Terraform Plan
      run: terraform plan

    - name: Terraform Apply
      run: terraform apply -auto-approve

    - name: Log in to ACR
      run: |
        az acr login --name stucentsregistry

    - name: Build Docker image
      run: docker build -t stucentsregistry.azurecr.io/stucents-app1:v1 .

    - name: Scan Docker image with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        format: table
        exit-code: 0
        ignore-unfixed: true

    - name: Push Docker image
      run: docker push stucentsregistry.azurecr.io/stucents-app1:v1



